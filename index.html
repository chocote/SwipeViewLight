<html>

<head>

  <title>Swipe View Light</title>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">

  <script type="text/javascript" src="js/data.js"></script>
  <script type="text/javascript" src="js/jquery.js"></script>

  <script type="text/javascript" src="js/UISwipeViewLight.js?122"></script>
  <style media="screen">
    .image-scale-hack {
      transform: rotate( .0001deg);
    }
    .progress-ring {
      background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiIgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJ3aGl0ZSI+CiAgPHBhdGggdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMikiIGQ9Ik0wIDEyIFYyMCBINCBWMTJ6Ij4gCiAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJkIiB2YWx1ZXM9Ik0wIDEyIFYyMCBINCBWMTJ6OyBNMCA0IFYyOCBINCBWNHo7IE0wIDEyIFYyMCBINCBWMTJ6OyBNMCAxMiBWMjAgSDQgVjEyeiIgZHVyPSIxLjJzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIgYmVnaW49IjAiIGtleXRpbWVzPSIwOy4yOy41OzEiIGtleVNwbGluZXM9IjAuMiAwLjIgMC40IDAuODswLjIgMC42IDAuNCAwLjg7MC4yIDAuOCAwLjQgMC44IiBjYWxjTW9kZT0ic3BsaW5lIiAgLz4KICA8L3BhdGg+CiAgPHBhdGggdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOCkiIGQ9Ik0wIDEyIFYyMCBINCBWMTJ6Ij4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9ImQiIHZhbHVlcz0iTTAgMTIgVjIwIEg0IFYxMno7IE0wIDQgVjI4IEg0IFY0ejsgTTAgMTIgVjIwIEg0IFYxMno7IE0wIDEyIFYyMCBINCBWMTJ6IiBkdXI9IjEuMnMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBiZWdpbj0iMC4yIiBrZXl0aW1lcz0iMDsuMjsuNTsxIiBrZXlTcGxpbmVzPSIwLjIgMC4yIDAuNCAwLjg7MC4yIDAuNiAwLjQgMC44OzAuMiAwLjggMC40IDAuOCIgY2FsY01vZGU9InNwbGluZSIgIC8+CiAgPC9wYXRoPgogIDxwYXRoIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE0KSIgZD0iTTAgMTIgVjIwIEg0IFYxMnoiPgogICAgPGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iZCIgdmFsdWVzPSJNMCAxMiBWMjAgSDQgVjEyejsgTTAgNCBWMjggSDQgVjR6OyBNMCAxMiBWMjAgSDQgVjEyejsgTTAgMTIgVjIwIEg0IFYxMnoiIGR1cj0iMS4ycyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiIGJlZ2luPSIwLjQiIGtleXRpbWVzPSIwOy4yOy41OzEiIGtleVNwbGluZXM9IjAuMiAwLjIgMC40IDAuODswLjIgMC42IDAuNCAwLjg7MC4yIDAuOCAwLjQgMC44IiBjYWxjTW9kZT0ic3BsaW5lIiAvPgogIDwvcGF0aD4KICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMCkiIGQ9Ik0wIDEyIFYyMCBINCBWMTJ6Ij4KICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9ImQiIHZhbHVlcz0iTTAgMTIgVjIwIEg0IFYxMno7IE0wIDQgVjI4IEg0IFY0ejsgTTAgMTIgVjIwIEg0IFYxMno7IE0wIDEyIFYyMCBINCBWMTJ6IiBkdXI9IjEuMnMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBiZWdpbj0iMC42IiBrZXl0aW1lcz0iMDsuMjsuNTsxIiBrZXlTcGxpbmVzPSIwLjIgMC4yIDAuNCAwLjg7MC4yIDAuNiAwLjQgMC44OzAuMiAwLjggMC40IDAuOCIgY2FsY01vZGU9InNwbGluZSIgLz4KICA8L3BhdGg+CiAgPHBhdGggdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjYpIiBkPSJNMCAxMiBWMjAgSDQgVjEyeiI+CiAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJkIiB2YWx1ZXM9Ik0wIDEyIFYyMCBINCBWMTJ6OyBNMCA0IFYyOCBINCBWNHo7IE0wIDEyIFYyMCBINCBWMTJ6OyBNMCAxMiBWMjAgSDQgVjEyeiIgZHVyPSIxLjJzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIgYmVnaW49IjAuOCIga2V5dGltZXM9IjA7LjI7LjU7MSIga2V5U3BsaW5lcz0iMC4yIDAuMiAwLjQgMC44OzAuMiAwLjYgMC40IDAuODswLjIgMC44IDAuNCAwLjgiIGNhbGNNb2RlPSJzcGxpbmUiIC8+CiAgPC9wYXRoPgo8L3N2Zz4K);
      background-repeat: no-repeat;
      background-position: center center;
      height: 100%;
      width: 100%;
      background-color: #DDD;
      position: absolute;
      left: 0;
      top: 0;
    }
  </style>

  <script type="text/javascript">
    /* Abortable download images JS */
    (function(f) {
      this.CDImage = {
        load: function(g, h) {
          var e, c = f.createElement("iframe"),
            k = function() {
              var b;
              a: {
                var a = c;
                if (a) try {
                  var d = a.contentWindow;
                  d && d.stop ? d.stop() : d = a.contentDocument;
                  d && d.execCommand && d.execCommand("Stop", !1);
                  a.parentNode.removeChild(a);
                  b = !0;
                  break a
                } catch (f) {
                  throw f.toString();
                }
                b = void 0
              }
              b && (c = null);
              e = null;
              return !0 === b ? g : b
            },
            a = null;
          c.style.display = "none";
          f.body.appendChild(c);
          e = c.contentDocument || c.contentWindow.document;
          e.open();
          a = function() {
            this.removeEventListener ? this.removeEventListener("load",
              a, !1) : this.detachEvent("onload", a);
            var b = new Image;
            b.onload = function() {
              this.onload = null;
              k();
              h && h(g, b)
            };
            e.body.appendChild(b);
            b.src = g
          };
          c.addEventListener ? c.addEventListener("load", a, !1) : c.attachEvent("onload", a);
          e.close();
          return {
            abort: k
          }
        }
      }
    }).call(window, window.document);




    Events = (function() {

      var ArrayProto = Array.prototype,
        ObjProto = Object.prototype,
        FuncProto = Function.prototype,
        push = ArrayProto.push,
        slice = ArrayProto.slice,
        concat = ArrayProto.concat,
        toString = ObjProto.toString,
        hasOwnProperty = ObjProto.hasOwnProperty,
        fireEvents = function(events, args) {
          var ev, i = -1,
            l = events.length,
            a1 = args[0],
            a2 = args[1],
            a3 = args[2];
          switch (args.length) {
            case 0:
              while (++i < l)(ev = events[i]).callback.call(ev.ctx);
              return;
            case 1:
              while (++i < l)(ev = events[i]).callback.call(ev.ctx, a1);
              return;
            case 2:
              while (++i < l)(ev = events[i]).callback.call(ev.ctx, a1, a2);
              return;
            case 3:
              while (++i < l)(ev = events[i]).callback.call(ev.ctx, a1, a2, a3);
              return;
            default:
              while (++i < l)(ev = events[i]).callback.apply(ev.ctx, args);
              return;
          }
        };

      if (!Object.keys) {
        Object.keys = (function() {
          'use strict';
          var hasOwnProperty = Object.prototype.hasOwnProperty,
            hasDontEnumBug = !({
              toString: null
            }).propertyIsEnumerable('toString'),
            dontEnums = [
              'toString',
              'toLocaleString',
              'valueOf',
              'hasOwnProperty',
              'isPrototypeOf',
              'propertyIsEnumerable',
              'constructor'
            ],
            dontEnumsLength = dontEnums.length;

          return function(obj) {
            if (typeof obj !== 'object' && (typeof obj !== 'function' || obj === null)) {
              throw new TypeError('Object.keys called on non-object');
            }

            var result = [],
              prop, i;

            for (prop in obj) {
              if (hasOwnProperty.call(obj, prop)) {
                result.push(prop);
              }
            }

            if (hasDontEnumBug) {
              for (i = 0; i < dontEnumsLength; i++) {
                if (hasOwnProperty.call(obj, dontEnums[i])) {
                  result.push(dontEnums[i]);
                }
              }
            }
            return result;
          };
        }());
      }

      return {

        on: function(name, callback, context) {
          this._events || (this._events = {});
          var events = this._events[name] || (this._events[name] = []);
          events.push({
            callback: callback,
            context: context,
            ctx: context || this
          });
          return this;
        },


        once: function(name, callback, context) {

          var self = this;
          var once = (function(func) {
            var memo, times = 2;
            return function() {
              if (--times > 0) {
                memo = func.apply(this, arguments);
              } else {
                func = null;
              }
              return memo;
            };
          })(function() {
            self.off(name, once);
            if (callback)
                callback.apply(this, arguments);
          });
          return this.on(name, once, context);
        },


        off: function(name, callback, context) {
          var retain, ev, events, names, i, l, j, k;
          if (!name && !callback && !context) {
            this._events = void 0;
            return this;
          }
          names = name ? [name] : Object.keys(this._events);
          for (i = 0, l = names.length; i < l; i++) {
            name = names[i];
            if (events = this._events[name]) {
              this._events[name] = retain = [];
              if (callback || context) {
                for (j = 0, k = events.length; j < k; j++) {
                  ev = events[j];
                  if ((callback && callback !== ev.callback && callback !== ev.callback._callback) ||
                    (context && context !== ev.context)) {
                    retain.push(ev);
                  }
                }
              }
              if (!retain.length) delete this._events[name];
            }
          }

          return this;
        },


        trigger: function(name) {
          if (!this._events) return this;
          var args = slice.call(arguments, 1);
          var events = this._events[name];
          var allEvents = this._events.all;
          if (events) fireEvents(events, args);
          if (allEvents) fireEvents(allEvents, arguments);
          return this;
        }

      };

    }());

    var gallery;

    function init() {

      function MediaGallery(data, options) {
        var that = this;
        that.options = $.extend({
          index: 0
        }, options);
        that.el = document.createElement('div');
        that.$el = $(that.el).addClass(this.className).css({
          'position': 'relative',
          'overflow': 'hidden',
          'width': '100%',
          'height': '90%',
          'left': 0,
          'top': 0
        }).focus();

        that.isOpen = false;
        that.dom = {};
        that.dom.content = $('<div/>').addClass('ui-media-gallery-content').css({
          'position': 'absolute',
          'left': 0,
          'top': 0,
          'right': 0,
          'bottom': 0
        }).appendTo(this.el);



        that.uiSwipeView = null;

        that.views = $.map(data, function(obj) {
          return new GalleryImageView({
            model: obj
          })
        });

        if (that.views.length === 1) {
          that.dom.btns.hide();
        }

      }

      $.extend(MediaGallery.prototype, Events, {
        constructor: MediaGallery,
        className: 'media-gallery',
        render: function() {
          var that = this;
          that.uiSwipeView = new UISwipeViewLight(that.dom.content[0], that.views, $.extend({
            height: that.dom.content.height(),
            width: that.dom.content.width(),
            slideSpeed: 750
          }, this.options)).on('changeView', function(view) {
            that.loadAndShowView();
            that.trigger('changePage');
          }).on('slideAdded', function(view) {
            view.resize();
          }).on('resize', function() {
            this.getView().resize();
          });

          that.uiSwipeView.slide = function(action) {
            switch (action) {
              case 'swipeleft':
              case 'swipetop':
                that.trigger('next');
                break;
              case 'swiperight':
              case 'swipebottom':
                that.trigger('prev');
                break;
            }
          };

          that.dom.content.append(that.uiSwipeView.el);
          that.uiSwipeView.show(that.uiSwipeView.getView());
          that.loadAndShowView();
        },

        loadAndShowView: function(view) {
          var that = this;
          view = view || that.uiSwipeView.getView();
          view.show(function() {
              that._preloadAsides();
          });
        },
        _preloadAsides: function(){
            var that = this,
                uiSwipeView = that.uiSwipeView,
                asideIndexes = that._getAsideIndexes(uiSwipeView.index, uiSwipeView.views.length),
                _prevView = uiSwipeView.getView(asideIndexes[0]),
                _nextView = uiSwipeView.getView(asideIndexes[1]);
            _nextView.preload();
            _prevView.preload();
        },
        _getAsideIndexes: function(index, len) {
          var nextIndex = index + 1,
            prevIndex = index - 1;
          if (nextIndex > len - 1) {
            nextIndex = 0;
          }
          if (prevIndex < 0) {
            prevIndex = len - 1;
          }
          return [prevIndex, nextIndex];
        },

        destroy: function() {
          this.uiSwipeView.destroy();
          this.$el.remove();
        }
      });

      function GalleryImageView(options) {
        var that = this;
        that.el = document.createElement('div');
        that.$el = $(that.el).addClass(this.className).css({
          'position': 'absolute',
          'left': 0,
          'top': 0,
          'width': '100%',
          'height': '100%'
        });
        that.model = options.model;
        that.downloadRequest = null;
        that.downloading = false;
        that.loaded = false;
        that.size = {
          width: 0,
          height: 0
        };
        that.spinner = new Spinner();

        that.image = $(new Image()).css({
          'position': 'absolute',
          'display': 'none'
        });
        //Hack Firefox SmoothImage
        if ("MozAppearance" in document.documentElement.style) {
          that.image.addClass('image-scale-hack');
        }
        that.$el.append(this.image);
        that.showSpinner();
      }

      $.extend(GalleryImageView.prototype, Events, {
        constructor: GalleryImageView,
        className: 'media-gallery-image-view',
        show: function(callback) {
          var that = this;
          if (that.loaded) {
            that.resize();
            that.image.show();
            that.hideSpinner();
            callback && callback.call(that);
          } else {
            that.showSpinner();
            that.preload(function() {
              that.show(callback);
            });
          }
        },
        preload: function(callback) {
          if (this.loaded) {
            callback && callback.call(this);
            return;
          }
          if (!this.downloading) {
            this.once('downloaded', callback);
            this.download();
          }
          return this.downloadRequest;
        },

        download: function() {
          var that = this;
          that.downloading = true;
          that.downloadRequest = CDImage.load(this.model.src, function(src, img) {
            that.size.width = img.width;
            that.size.height = img.height;
            that._downloaded();
          });
          return that.downloadRequest;
        },
        resize: function(wW, wH) {

            var iH = this.size.height,
              iW = this.size.width,
              scale;

            wW = wW === undefined ? this.$el.width() : wW;
            wH = wH === undefined ? this.$el.height() : wH;

            scale = (wH / wW) > (iH / iW) ? wW / iW : wH / iH;

            this.image.css({
              width: iW * scale,
              height: iH * scale,
              left: (wW - iW * scale) / 2,
              top: (wH - iH * scale) / 2
            });

        },
        abortDownload: function() {
          var that = this;
          if (that.downloadRequest) {
            that.downloadRequest.abort();
            that.downloadRequest = null;
            that.downloading = false;
            that.off('downloaded');
          }
        },
        _downloaded: function() {
          var that = this,
            cb;
          that.downloadRequest = null;
          that.downloading = false;
          that.loaded = true;
          that.image.attr('src', this.model.src);
          that.resize();
          that.hideSpinner();
          that.image.show();
          that.trigger('downloaded');
        },
        showSpinner: function() {
          this.$el.append(this.spinner.el);
        },
        hideSpinner: function() {
          this.spinner.$el.detach();
        },
        detach: function() {
          this.$el.detach();
        }
      });

      function Spinner() {
        this.$el = $('<div class="progress-ring"></div>');
        this.el = this.$el.get(0);
      }
      $.extend(Spinner.prototype, Events, {
        constructor: Spinner,
        destroy: function() {
          this.$el.remove();
        }
      })


      // Implementation

      gallery = new MediaGallery(data.pages, {
        index: 0
      });

      var baseURL = 'http://' + location.host + location.pathname.replace(/\/+$/, '');

      $('body').append(gallery.$el);

      gallery.on('next', function() {
        if (this.uiSwipeView.isSliding)
          return
        if (typeof history.pushState == 'function') {
          var newURL = baseURL + '/' + (this.uiSwipeView.views.length - 1 === this.uiSwipeView.index ? 1 : this.uiSwipeView.index + 2);
          history.pushState(null, '', newURL);
          dispatch();
        } else {
          this.uiSwipeView.next();
        }
      });

      gallery.on('prev', function() {
        if (this.uiSwipeView.isSliding)
          return
        if (typeof history.pushState == 'function') {
          var newURL = baseURL + '/' + (this.uiSwipeView.index === 0 ? this.uiSwipeView.views.length : this.uiSwipeView.index);
          history.pushState(null, '', newURL);
          dispatch();
        } else {
          this.uiSwipeView.prev();
        }
      });



      var lastPage = getURLPage();

      function getURLPage(){
          var page, out = (new RegExp(baseURL + "\\/(\\d+)")).exec(location);
          if (out === null) {
            page = 1;
          } else {
            page = parseInt(out[1]);
          }
          return page;
      }

      function go() {
        gallery.uiSwipeView.goTo(lastPage - 1);
      }

      function dispatch() {

        lastPage = getURLPage();

        if (gallery.uiSwipeView.isSliding) {
          gallery.off('changePage', go).on('changePage', go);
        } else {
          go();
        }
        //console.log(lastPage);
      }


      $(window).off('popstate').on('popstate', dispatch);

      gallery.render();

    }

    function next() {
      gallery.trigger("next");
    }

    function prev() {
      gallery.trigger("prev");
    }


    // Document Ready
    $(init);
  </script>

</head>

<body>
  <p style="text-align:center; position:absolute; bottom:0; width:100%; left:0; ">
  <button onclick="prev()">Prev</button>
  <button onclick="next()">Next</button>
  <p>
</body>

</html>
